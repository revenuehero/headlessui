import ee,{Fragment as xe,createContext as pe,createRef as Ce,useCallback as Oe,useContext as se,useEffect as be,useMemo as M,useReducer as ge,useRef as E}from"react";import{useComputed as ne}from'../../hooks/use-computed.js';import{useDisposables as re}from'../../hooks/use-disposables.js';import{useEvent as C}from'../../hooks/use-event.js';import{useId as Q}from'../../hooks/use-id.js';import{useIsoMorphicEffect as w}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as ye}from'../../hooks/use-latest-value.js';import{useOutsideClick as Re}from'../../hooks/use-outside-click.js';import{useResolveButtonType as ve}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as Y}from'../../hooks/use-sync-refs.js';import{useTreeWalker as Pe}from'../../hooks/use-tree-walker.js';import{calculateActiveIndex as Ae,Focus as y}from'../../utils/calculate-active-index.js';import{disposables as de}from'../../utils/disposables.js';import{forwardRefWithAs as G,render as X,compact as Ee,Features as fe}from'../../utils/render.js';import{isDisabledReactIssue7711 as Se}from'../../utils/bugs.js';import{match as j}from'../../utils/match.js';import{objectToFormEntries as Ie}from'../../utils/form.js';import{sortByDomNode as Le}from'../../utils/focus-management.js';import{Hidden as Ve,Features as De}from'../../internal/hidden.js';import{useOpenClosed as Fe,State as oe,OpenClosedProvider as Me}from'../../internal/open-closed.js';import{Keys as v}from'../keyboard.js';import{useControllable as _e}from'../../hooks/use-controllable.js';import{useWatch as ce}from'../../hooks/use-watch.js';import{useTrackedPointer as he}from'../../hooks/use-tracked-pointer.js';import{isMobile as Be}from'../../utils/platform.js';var ke=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(ke||{}),we=(e=>(e[e.Single=0]="Single",e[e.Multi=1]="Multi",e))(we||{}),Ue=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(Ue||{}),He=(n=>(n[n.OpenCombobox=0]="OpenCombobox",n[n.CloseCombobox=1]="CloseCombobox",n[n.GoToOption=2]="GoToOption",n[n.RegisterOption=3]="RegisterOption",n[n.UnregisterOption=4]="UnregisterOption",n[n.RegisterLabel=5]="RegisterLabel",n))(He||{});function ae(t,l=e=>e){let e=t.activeOptionIndex!==null?t.options[t.activeOptionIndex]:null,r=Le(l(t.options.slice()),b=>b.dataRef.current.domRef.current),a=e?r.indexOf(e):null;return a===-1&&(a=null),{options:r,activeOptionIndex:a}}let Ne={[1](t){var l;return(l=t.dataRef.current)!=null&&l.disabled||t.comboboxState===1?t:{...t,activeOptionIndex:null,comboboxState:1}},[0](t){var e;if((e=t.dataRef.current)!=null&&e.disabled||t.comboboxState===0)return t;let l=t.activeOptionIndex;if(t.dataRef.current){let{isSelected:r}=t.dataRef.current,a=t.options.findIndex(b=>r(b.dataRef.current.value));a!==-1&&(l=a)}return{...t,comboboxState:0,activeOptionIndex:l}},[2](t,l){var a,b,n,d;if((a=t.dataRef.current)!=null&&a.disabled||(b=t.dataRef.current)!=null&&b.optionsRef.current&&!((n=t.dataRef.current)!=null&&n.optionsPropsRef.current.static)&&t.comboboxState===1)return t;let e=ae(t);if(e.activeOptionIndex===null){let o=e.options.findIndex(i=>!i.dataRef.current.disabled);o!==-1&&(e.activeOptionIndex=o)}let r=Ae(l,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:o=>o.id,resolveDisabled:o=>o.dataRef.current.disabled});return{...t,...e,activeOptionIndex:r,activationTrigger:(d=l.trigger)!=null?d:1}},[3]:(t,l)=>{var b,n;let e={id:l.id,dataRef:l.dataRef},r=ae(t,d=>[...d,e]);t.activeOptionIndex===null&&(b=t.dataRef.current)!=null&&b.isSelected(l.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(e));let a={...t,...r,activationTrigger:1};return(n=t.dataRef.current)!=null&&n.__demoMode&&t.dataRef.current.value===void 0&&(a.activeOptionIndex=0),a},[4]:(t,l)=>{let e=ae(t,r=>{let a=r.findIndex(b=>b.id===l.id);return a!==-1&&r.splice(a,1),r});return{...t,...e,activationTrigger:1}},[5]:(t,l)=>({...t,labelId:l.id})},le=pe(null);le.displayName="ComboboxActionsContext";function Z(t){let l=se(le);if(l===null){let e=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(e,Z),e}return l}let ie=pe(null);ie.displayName="ComboboxDataContext";function J(t){let l=se(ie);if(l===null){let e=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(e,J),e}return l}function Ge(t,l){return j(l.type,Ne,t,l)}let Xe=xe;function je(t,l){let{value:e,defaultValue:r,onChange:a,form:b,name:n,by:d=(p,m)=>p===m,disabled:o=!1,__demoMode:i=!1,nullable:P=!1,multiple:f=!1,...S}=t,[T=f?[]:void 0,g]=_e(e,a,r),[c,x]=ge(Ge,{dataRef:Ce(),comboboxState:i?0:1,options:[],activeOptionIndex:null,activationTrigger:1,labelId:null}),V=E(!1),_=E({static:!1,hold:!1}),U=E(null),H=E(null),N=E(null),K=E(null),h=C(typeof d=="string"?(p,m)=>{let R=d;return(p==null?void 0:p[R])===(m==null?void 0:m[R])}:d),B=Oe(p=>j(s.mode,{[1]:()=>T.some(m=>h(m,p)),[0]:()=>h(T,p)}),[T]),s=M(()=>({...c,optionsPropsRef:_,labelRef:U,inputRef:H,buttonRef:N,optionsRef:K,value:T,defaultValue:r,disabled:o,mode:f?1:0,get activeOptionIndex(){if(V.current&&c.activeOptionIndex===null&&c.options.length>0){let p=c.options.findIndex(m=>!m.dataRef.current.disabled);if(p!==-1)return p}return c.activeOptionIndex},compare:h,isSelected:B,nullable:P,__demoMode:i}),[T,r,o,f,P,i,c]),O=E(s.activeOptionIndex!==null?s.options[s.activeOptionIndex]:null);be(()=>{let p=s.activeOptionIndex!==null?s.options[s.activeOptionIndex]:null;O.current!==p&&(O.current=p)}),w(()=>{c.dataRef.current=s},[s]),Re([s.buttonRef,s.inputRef,s.optionsRef],()=>te.closeCombobox(),s.comboboxState===0);let I=M(()=>({open:s.comboboxState===0,disabled:o,activeIndex:s.activeOptionIndex,activeOption:s.activeOptionIndex===null?null:s.options[s.activeOptionIndex].dataRef.current.value,value:T}),[s,o,T]),u=C(p=>{let m=s.options.find(R=>R.id===p);m&&$(m.dataRef.current.value)}),k=C(()=>{if(s.activeOptionIndex!==null){let{dataRef:p,id:m}=s.options[s.activeOptionIndex];$(p.current.value),te.goToOption(y.Specific,m)}}),L=C(()=>{x({type:0}),V.current=!0}),W=C(()=>{x({type:1}),V.current=!1}),A=C((p,m,R)=>(V.current=!1,p===y.Specific?x({type:2,focus:y.Specific,id:m,trigger:R}):x({type:2,focus:p,trigger:R}))),D=C((p,m)=>(x({type:3,id:p,dataRef:m}),()=>{var R;((R=O.current)==null?void 0:R.id)===p&&(V.current=!0),x({type:4,id:p})})),F=C(p=>(x({type:5,id:p}),()=>x({type:5,id:null}))),$=C(p=>j(s.mode,{[0](){return g==null?void 0:g(p)},[1](){let m=s.value.slice(),R=m.findIndex(q=>h(q,p));return R===-1?m.push(p):m.splice(R,1),g==null?void 0:g(m)}})),te=M(()=>({onChange:$,registerOption:D,registerLabel:F,goToOption:A,closeCombobox:W,openCombobox:L,selectActiveOption:k,selectOption:u}),[]),Te=l===null?{}:{ref:l},z=E(null),me=re();return be(()=>{z.current&&r!==void 0&&me.addEventListener(z.current,"reset",()=>{$(r)})},[z,$]),ee.createElement(le.Provider,{value:te},ee.createElement(ie.Provider,{value:s},ee.createElement(Me,{value:j(s.comboboxState,{[0]:oe.Open,[1]:oe.Closed})},n!=null&&T!=null&&Ie({[n]:T}).map(([p,m],R)=>ee.createElement(Ve,{features:De.Hidden,ref:R===0?q=>{var ue;z.current=(ue=q==null?void 0:q.closest("form"))!=null?ue:null}:void 0,...Ee({key:p,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:b,name:p,value:m})})),X({ourProps:Te,theirProps:S,slot:I,defaultTag:Xe,name:"Combobox"}))))}let Je="input";function Ke(t,l){var B,s,O,I;let e=Q(),{id:r=`headlessui-combobox-input-${e}`,onChange:a,displayValue:b,type:n="text",...d}=t,o=J("Combobox.Input"),i=Z("Combobox.Input"),P=Y(o.inputRef,l),f=E(!1),S=re(),T=function(){var u;return typeof b=="function"&&o.value!==void 0?(u=b(o.value))!=null?u:"":typeof o.value=="string"?o.value:""}();ce(([u,k],[L,W])=>{if(f.current)return;let A=o.inputRef.current;A&&((W===0&&k===1||u!==L)&&(A.value=u),requestAnimationFrame(()=>{if(f.current||!A)return;let{selectionStart:D,selectionEnd:F}=A;Math.abs((F!=null?F:0)-(D!=null?D:0))===0&&D===0&&A.setSelectionRange(A.value.length,A.value.length)}))},[T,o.comboboxState]),ce(([u],[k])=>{if(u===0&&k===1){let L=o.inputRef.current;if(!L)return;let W=L.value,{selectionStart:A,selectionEnd:D,selectionDirection:F}=L;L.value="",L.value=W,F!==null?L.setSelectionRange(A,D,F):L.setSelectionRange(A,D)}},[o.comboboxState]);let g=E(!1),c=E(null),x=C(()=>{g.current=!0}),V=C(()=>{S.nextFrame(()=>{g.current=!1,c.current&&(i.openCombobox(),a==null||a(c.current),c.current=null)})}),_=C(u=>{switch(f.current=!0,u.key){case v.Backspace:case v.Delete:if(o.mode!==0||!o.nullable)return;let k=u.currentTarget;S.requestAnimationFrame(()=>{k.value===""&&(i.onChange(null),o.optionsRef.current&&(o.optionsRef.current.scrollTop=0),i.goToOption(y.Nothing))});break;case v.Enter:if(f.current=!1,o.comboboxState!==0||g.current)return;if(u.preventDefault(),u.stopPropagation(),o.activeOptionIndex===null){i.closeCombobox();return}i.selectActiveOption(),o.mode===0&&i.closeCombobox();break;case v.ArrowDown:return f.current=!1,u.preventDefault(),u.stopPropagation(),j(o.comboboxState,{[0]:()=>{i.goToOption(y.Next)},[1]:()=>{i.openCombobox()}});case v.ArrowUp:return f.current=!1,u.preventDefault(),u.stopPropagation(),j(o.comboboxState,{[0]:()=>{i.goToOption(y.Previous)},[1]:()=>{i.openCombobox(),S.nextFrame(()=>{o.value||i.goToOption(y.Last)})}});case v.Home:if(u.shiftKey)break;return f.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(y.First);case v.PageUp:return f.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(y.First);case v.End:if(u.shiftKey)break;return f.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(y.Last);case v.PageDown:return f.current=!1,u.preventDefault(),u.stopPropagation(),i.goToOption(y.Last);case v.Escape:return f.current=!1,o.comboboxState!==0?void 0:(u.preventDefault(),o.optionsRef.current&&!o.optionsPropsRef.current.static&&u.stopPropagation(),i.closeCombobox());case v.Tab:if(f.current=!1,o.comboboxState!==0)return;o.mode===0&&i.selectActiveOption(),i.closeCombobox();break}}),U=C(u=>{if(g.current){c.current=u;return}i.openCombobox(),a==null||a(u)}),H=C(()=>{f.current=!1}),N=ne(()=>{if(o.labelId)return[o.labelId].join(" ")},[o.labelId]),K=M(()=>({open:o.comboboxState===0,disabled:o.disabled}),[o]),h={ref:P,id:r,role:"combobox",type:n,"aria-controls":(B=o.optionsRef.current)==null?void 0:B.id,"aria-expanded":o.disabled?void 0:o.comboboxState===0,"aria-activedescendant":o.activeOptionIndex===null||(s=o.options[o.activeOptionIndex])==null?void 0:s.id,"aria-labelledby":N,"aria-autocomplete":"list",defaultValue:(I=(O=t.defaultValue)!=null?O:o.defaultValue!==void 0?b==null?void 0:b(o.defaultValue):null)!=null?I:o.defaultValue,disabled:o.disabled,onCompositionStart:x,onCompositionEnd:V,onKeyDown:_,onChange:U,onBlur:H};return X({ourProps:h,theirProps:d,slot:K,defaultTag:Je,name:"Combobox.Input"})}let We="button";function $e(t,l){var g;let e=J("Combobox.Button"),r=Z("Combobox.Button"),a=Y(e.buttonRef,l),b=Q(),{id:n=`headlessui-combobox-button-${b}`,...d}=t,o=re(),i=C(c=>{switch(c.key){case v.ArrowDown:return c.preventDefault(),c.stopPropagation(),e.comboboxState===1&&r.openCombobox(),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})});case v.ArrowUp:return c.preventDefault(),c.stopPropagation(),e.comboboxState===1&&(r.openCombobox(),o.nextFrame(()=>{e.value||r.goToOption(y.Last)})),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})});case v.Escape:return e.comboboxState!==0?void 0:(c.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&c.stopPropagation(),r.closeCombobox(),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})}));default:return}}),P=C(c=>{if(Se(c.currentTarget))return c.preventDefault();e.comboboxState===0?r.closeCombobox():(c.preventDefault(),r.openCombobox()),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})})}),f=ne(()=>{if(e.labelId)return[e.labelId,n].join(" ")},[e.labelId,n]),S=M(()=>({open:e.comboboxState===0,disabled:e.disabled,value:e.value}),[e]),T={ref:a,id:n,type:ve(t,e.buttonRef),tabIndex:-1,"aria-haspopup":"listbox","aria-controls":(g=e.optionsRef.current)==null?void 0:g.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-labelledby":f,disabled:e.disabled,onClick:P,onKeyDown:i};return X({ourProps:T,theirProps:d,slot:S,defaultTag:We,name:"Combobox.Button"})}let qe="label";function Qe(t,l){let e=Q(),{id:r=`headlessui-combobox-label-${e}`,...a}=t,b=J("Combobox.Label"),n=Z("Combobox.Label"),d=Y(b.labelRef,l);w(()=>n.registerLabel(r),[r]);let o=C(()=>{var f;return(f=b.inputRef.current)==null?void 0:f.focus({preventScroll:!0})}),i=M(()=>({open:b.comboboxState===0,disabled:b.disabled}),[b]);return X({ourProps:{ref:d,id:r,onClick:o},theirProps:a,slot:i,defaultTag:qe,name:"Combobox.Label"})}let Ye="ul",Ze=fe.RenderStrategy|fe.Static;function ze(t,l){let e=Q(),{id:r=`headlessui-combobox-options-${e}`,hold:a=!1,...b}=t,n=J("Combobox.Options"),d=Y(n.optionsRef,l),o=Fe(),i=(()=>o!==null?(o&oe.Open)===oe.Open:n.comboboxState===0)();w(()=>{var T;n.optionsPropsRef.current.static=(T=t.static)!=null?T:!1},[n.optionsPropsRef,t.static]),w(()=>{n.optionsPropsRef.current.hold=a},[n.optionsPropsRef,a]),Pe({container:n.optionsRef.current,enabled:n.comboboxState===0,accept(T){return T.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:T.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(T){T.setAttribute("role","none")}});let P=ne(()=>{var T,g;return(g=n.labelId)!=null?g:(T=n.buttonRef.current)==null?void 0:T.id},[n.labelId,n.buttonRef.current]),f=M(()=>({open:n.comboboxState===0}),[n]),S={"aria-labelledby":P,role:"listbox","aria-multiselectable":n.mode===1?!0:void 0,id:r,ref:d};return X({ourProps:S,theirProps:b,slot:f,defaultTag:Ye,features:Ze,visible:i,name:"Combobox.Options"})}let eo="li";function oo(t,l){var B,s;let e=Q(),{id:r=`headlessui-combobox-option-${e}`,disabled:a=!1,value:b,...n}=t,d=J("Combobox.Option"),o=Z("Combobox.Option"),i=d.activeOptionIndex!==null?d.options[d.activeOptionIndex].id===r:!1,P=d.isSelected(b),f=E(null),S=ye({disabled:a,value:b,domRef:f,textValue:(s=(B=f.current)==null?void 0:B.textContent)==null?void 0:s.toLowerCase()}),T=Y(l,f),g=C(()=>o.selectOption(r));w(()=>o.registerOption(r,S),[S,r]);let c=E(!d.__demoMode);w(()=>{if(!d.__demoMode)return;let O=de();return O.requestAnimationFrame(()=>{c.current=!0}),O.dispose},[]),w(()=>{if(d.comboboxState!==0||!i||!c.current||d.activationTrigger===0)return;let O=de();return O.requestAnimationFrame(()=>{var I,u;(u=(I=f.current)==null?void 0:I.scrollIntoView)==null||u.call(I,{block:"nearest"})}),O.dispose},[f,i,d.comboboxState,d.activationTrigger,d.activeOptionIndex]);let x=C(O=>{if(a)return O.preventDefault();g(),d.mode===0&&o.closeCombobox(),Be()||requestAnimationFrame(()=>{var I;return(I=d.inputRef.current)==null?void 0:I.focus()})}),V=C(()=>{if(a)return o.goToOption(y.Nothing);o.goToOption(y.Specific,r)}),_=he(),U=C(O=>_.update(O)),H=C(O=>{_.wasMoved(O)&&(a||i||o.goToOption(y.Specific,r,0))}),N=C(O=>{_.wasMoved(O)&&(a||i&&(d.optionsPropsRef.current.hold||o.goToOption(y.Nothing)))}),K=M(()=>({active:i,selected:P,disabled:a}),[i,P,a]);return X({ourProps:{id:r,ref:T,role:"option",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:x,onFocus:V,onPointerEnter:U,onMouseEnter:U,onPointerMove:H,onMouseMove:H,onPointerLeave:N,onMouseLeave:N},theirProps:n,slot:K,defaultTag:eo,name:"Combobox.Option"})}let to=G(je),no=G($e),ro=G(Ke),ao=G(Qe),lo=G(ze),io=G(oo),Wo=Object.assign(to,{Input:ro,Button:no,Label:ao,Options:lo,Option:io});export{Wo as Combobox};
